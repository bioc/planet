---
title: "Predict Placental Cell Composition"
output: 
    rmarkdown::html_vignette:
        df_print: "kable"
        fig_caption: FALSE
        toc: TRUE
pkgdown:
    as_is: true
vignette: >
    %\VignetteIndexEntry{Predict Placental Cell Composition}
    %\VignetteEncoding{UTF-8}
    %\VignetteEngine{knitr::rmarkdown}
editor_options: 
    chunk_output_type: console
---

To infer cell composition on placental villi DNAm samples, we can use the
reference cpgs identified in [3]. These are provided in this package as
`plCellCpGsThird` and `plCellCpGsFirst` for third trimester (term) and
first trimester samples, respectively.

In this example we are using term villi DNAm data, so we first load the 
reference cpgs `plCellCpGsThird`. This is a data frame of 600 cpgs, with 
mean methylation levels for each cell type.




```r
# cell deconvolution packages
library(minfi)
#> Error in library(minfi): there is no package called 'minfi'
library(EpiDISH)
#> Error in library(EpiDISH): there is no package called 'EpiDISH'

# data wrangling and plotting
library(dplyr)
library(ggplot2)
library(tidyr)

library(planet)
#> Error in library(planet): there is no package called 'planet'

# load example data
data("plBetas")
data("plCellCpGsThird")
head(plCellCpGsThird)
#> Error in head(plCellCpGsThird): object 'plCellCpGsThird' not found
```

After our reference cpg data is loaded, we can estimate cell composition by
applying either the Constrained Projection approach implemented by the R 
packages minfi or EpiDISH, or a non-constrained approach by EpiDish.

#### Minfi


```r
houseman_estimates <- minfi:::projectCellType(
    plBetas[rownames(plCellCpGsThird), ],
    plCellCpGsThird,
    lessThanOne = FALSE
)
#> Error in loadNamespace(name): there is no package called 'minfi'

head(houseman_estimates)
#> Error in head(houseman_estimates): object 'houseman_estimates' not found
```

#### EpiDish


```r
# robust partial correlations
epidish_RPC <- epidish(
    beta.m = plBetas[rownames(plCellCpGsThird), ],
    ref.m = plCellCpGsThird,
    method = "RPC"
)
#> Error in epidish(beta.m = plBetas[rownames(plCellCpGsThird), ], ref.m = plCellCpGsThird, : could not find function "epidish"

# CIBERSORT
epidish_CBS <- epidish(
    beta.m = plBetas[rownames(plCellCpGsThird), ],
    ref.m = plCellCpGsThird,
    method = "CBS"
)
#> Error in epidish(beta.m = plBetas[rownames(plCellCpGsThird), ], ref.m = plCellCpGsThird, : could not find function "epidish"

# constrained projection (houseman 2012)
epidish_CP <- epidish(
    beta.m = plBetas[rownames(plCellCpGsThird), ],
    ref.m = plCellCpGsThird,
    method = "CP"
)
#> Error in epidish(beta.m = plBetas[rownames(plCellCpGsThird), ], ref.m = plCellCpGsThird, : could not find function "epidish"
```

### Compare

We can compare the different cell composition estimates.


```r
data("plColors")
#> Warning in data("plColors"): data set 'plColors' not found

# bind estimate data frames and reshape for plotting
bind_rows(
    houseman_estimates %>% as.data.frame() %>% 
        mutate(algorithm = "CP (Houseman)"),
    epidish_RPC$estF %>% as.data.frame() %>% mutate(algorithm = "RPC"),
    epidish_CBS$estF %>% as.data.frame() %>% mutate(algorithm = "CBS"),
    epidish_CP$estF %>% as.data.frame() %>% mutate(algorithm = "CP (EpiDISH)")
) %>%
    mutate(sample = rep(rownames(houseman_estimates), 4)) %>%
    as_tibble() %>%
    pivot_longer(
        cols = -c(algorithm, sample),
        names_to = "component",
        values_to = "estimate"
    ) %>%

    # relevel for plot
    mutate(component = factor(component,
        levels = c(
            "nRBC", "Endothelial", "Hofbauer",
            "Stromal", "Trophoblasts",
            "Syncytiotrophoblast"
        )
    )) %>%

    # plot
    ggplot(aes(x = sample, y = estimate, fill = component)) +
    geom_bar(stat = "identity") +
    facet_wrap(~algorithm, ncol = 1) +
    scale_fill_manual(values = plColors) +
    scale_y_continuous(
        limits = c(-0.1, 1.1), breaks = c(0, 0.5, 1),
        labels = scales::percent
    ) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
    coord_cartesian(ylim = c(0, 1)) +
    labs(x = "", fill = "")
#> Error in as.data.frame(.): object 'houseman_estimates' not found
```

Some notes:

* Normalize your data with `minfi::preprocessNoob`
* Use all cell CpGs, if some are missing, estimates may vary
* If your samples have been processed in a particular manner, (e.g. sampling 
from maternal side) expect cell composition to reflect that

### References

1. [Victor Yuan, Desmond Hui, Yifan Yin et al. Cell-specific Characterization 
of the Placental Methylome, 29 October 2020, PREPRINT (Version 3) available at
Research Square](https://www.researchsquare.com/article/rs-38223/v3)

### Session Info


```r
sessionInfo()
#> R version 4.0.3 (2020-10-10)
#> Platform: x86_64-w64-mingw32/x64 (64-bit)
#> Running under: Windows 10 x64 (build 19042)
#> 
#> Matrix products: default
#> 
#> locale:
#> [1] LC_COLLATE=English_Canada.1252  LC_CTYPE=English_Canada.1252   
#> [3] LC_MONETARY=English_Canada.1252 LC_NUMERIC=C                   
#> [5] LC_TIME=English_Canada.1252    
#> 
#> attached base packages:
#> [1] stats     graphics  grDevices utils     datasets  methods   base     
#> 
#> other attached packages:
#> [1] tidyr_1.1.2   dplyr_1.0.2   ggplot2_3.3.2
#> 
#> loaded via a namespace (and not attached):
#>  [1] knitr_1.30       magrittr_2.0.1   tidyselect_1.1.0 munsell_0.5.0   
#>  [5] colorspace_2.0-0 here_1.0.1       R6_2.5.0         rlang_0.4.9     
#>  [9] stringr_1.4.0    tools_4.0.3      grid_4.0.3       gtable_0.3.0    
#> [13] xfun_0.19        withr_2.3.0      htmltools_0.5.0  ellipsis_0.3.1  
#> [17] yaml_2.2.1       rprojroot_2.0.2  digest_0.6.27    tibble_3.0.4    
#> [21] lifecycle_0.2.0  crayon_1.3.4     purrr_0.3.4      vctrs_0.3.6     
#> [25] glue_1.4.2       evaluate_0.14    rmarkdown_2.6    stringi_1.5.3   
#> [29] compiler_4.0.3   pillar_1.4.7     generics_0.1.0   scales_1.1.1    
#> [33] pkgconfig_2.0.3
```
