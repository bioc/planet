---
title: "Predict Placental Cell Composition"
output: 
    rmarkdown::html_vignette:
        df_print: "kable"
        fig_caption: FALSE
pkgdown:
    as_is: true
vignette: >
    %\VignetteIndexEntry{Predict Placental Cell Composition}
    %\VignetteEncoding{UTF-8}
    %\VignetteEngine{knitr::rmarkdown}
editor_options: 
    chunk_output_type: console
---

To infer cell composition on placental villi DNAm samples, we can use the
reference cpgs identified in [3]. These are provided in this package as
`plCellCpGsThird` and `plCellCpGsFirst` for third trimester (term) and
first trimester samples, respectively.

In this example we are using term villi DNAm data, so we first load the 
reference cpgs `plCellCpGsThird`. This is a data frame of 600 cpgs, with 
mean methylation levels for each cell type.




```r
# cell deconvolution packages
library(minfi)
#> Error: package 'bumphunter' could not be loaded
library(EpiDISH)

# data wrangling and plotting
library(dplyr)
library(ggplot2)
library(tidyr)

library(planet)

# load example data
data("plBetas")
data("plCellCpGsThird")
head(plCellCpGsThird)
#>            Trophoblasts   Stromal  Hofbauer Endothelial      nRBC
#> cg10590657    0.1014098 0.9345796 0.8655285   0.8963641 0.8448382
#> cg14923398    0.1282030 0.8902107 0.9036769   0.9383641 0.9508709
#> cg05348366    0.1305697 0.9519820 0.8803082   0.9065136 0.9278057
#> cg17907628    0.1215249 0.9278777 0.8727841   0.8914412 0.9143601
#> cg26799656    0.1259953 0.9482014 0.8803863   0.8791004 0.9010419
#> cg11862144    0.1561991 0.9430855 0.9114967   0.9341671 0.9647331
#>            Syncytiotrophoblast
#> cg10590657          0.05460441
#> cg14923398          0.05383193
#> cg05348366          0.06546727
#> cg17907628          0.05325227
#> cg26799656          0.06823985
#> cg11862144          0.06044207
```

After our reference cpg data is loaded, we can estimate cell composition by
applying either the Constrained Projection approach implemented by the R 
packages minfi or EpiDISH, or a non-constrained approach by EpiDish.

#### Minfi


```r
houseman_estimates <- minfi:::projectCellType(
    plBetas[rownames(plCellCpGsThird), ],
    plCellCpGsThird,
    lessThanOne = FALSE
)
#> Error in loadNamespace(i, c(lib.loc, .libPaths()), versionCheck = vI[[i]]): there is no package called 'HDF5Array'

head(houseman_estimates)
#> Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'head': object 'houseman_estimates' not found
```

#### EpiDish


```r
# robust partial correlations
epidish_RPC <- epidish(
    beta.m = plBetas[rownames(plCellCpGsThird), ],
    ref.m = plCellCpGsThird,
    method = "RPC"
)

# CIBERSORT
epidish_CBS <- epidish(
    beta.m = plBetas[rownames(plCellCpGsThird), ],
    ref.m = plCellCpGsThird,
    method = "CBS"
)

# constrained projection (houseman 2012)
epidish_CP <- epidish(
    beta.m = plBetas[rownames(plCellCpGsThird), ],
    ref.m = plCellCpGsThird,
    method = "CP"
)
```

### Compare

We can compare the different cell composition estimates.


```r
data("plColors")

# bind estimate data frames and reshape for plotting
bind_rows(
    houseman_estimates %>% as.data.frame() %>% 
        mutate(algorithm = "CP (Houseman)"),
    epidish_RPC$estF %>% as.data.frame() %>% mutate(algorithm = "RPC"),
    epidish_CBS$estF %>% as.data.frame() %>% mutate(algorithm = "CBS"),
    epidish_CP$estF %>% as.data.frame() %>% mutate(algorithm = "CP (EpiDISH)")
) %>%
    mutate(sample = rep(rownames(houseman_estimates), 4)) %>%
    as_tibble() %>%
    pivot_longer(
        cols = -c(algorithm, sample),
        names_to = "component",
        values_to = "estimate"
    ) %>%

    # relevel for plot
    mutate(component = factor(component,
        levels = c(
            "nRBC", "Endothelial", "Hofbauer",
            "Stromal", "Trophoblasts",
            "Syncytiotrophoblast"
        )
    )) %>%

    # plot
    ggplot(aes(x = sample, y = estimate, fill = component)) +
    geom_bar(stat = "identity") +
    facet_wrap(~algorithm, ncol = 1) +
    scale_fill_manual(values = plColors) +
    scale_y_continuous(
        limits = c(-0.1, 1.1), breaks = c(0, 0.5, 1),
        labels = scales::percent
    ) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
    coord_cartesian(ylim = c(0, 1)) +
    labs(x = "", fill = "")
#> Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'as.data.frame': object 'houseman_estimates' not found
```

Some notes:

* Normalize your data with `minfi::preprocessNoob`
* Use all cell CpGs, if some are missing, estimates may vary
* If your samples have been processed in a particular manner, (e.g. sampling 
from maternal side) expect cell composition to reflect that

### References

1. [Victor Yuan, Desmond Hui, Yifan Yin et al. Cell-specific Characterization 
of the Placental Methylome, 29 October 2020, PREPRINT (Version 3) available at
Research Square](https://www.researchsquare.com/article/rs-38223/v3)
