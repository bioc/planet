---
title: "Predict Placental Cell Composition"
output: 
    rmarkdown::html_vignette:
        df_print: "kable"
        fig_caption: FALSE
        toc: TRUE
pkgdown:
    as_is: true
vignette: >
    %\VignetteIndexEntry{Predict Placental Cell Composition}
    %\VignetteEncoding{UTF-8}
    %\VignetteEngine{knitr::rmarkdown}
editor_options: 
    chunk_output_type: console
---

### Installation

```{r, eval = FALSE}
if(!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("planet")
```

### Set up

To infer cell composition on placental villi DNAm samples, we can use the
reference cpgs identified in [3]. These are provided in this package as
`plCellCpGsThird` and `plCellCpGsFirst` for third trimester (term) and
first trimester samples, respectively.

In this example we are using term villi DNAm data, so we first load the 
reference cpgs `plCellCpGsThird`. This is a data frame of 600 cpgs, with 
mean methylation levels for each cell type.

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE, 
    comment = "#>", 
    fig.width = 7, 
    fig.height = 7, 
    fig.align = "center",
    fig.path = "fig/",
    dpi=300)
knitr::opts_knit$set(
    base.dir = "vignettes"
)

library(ggplot2)
ggplot2::theme_set(theme_minimal(base_size = 14))
```


```{r, message = FALSE, warning = FALSE}
# cell deconvolution packages
# library(minfi) # currently not installable on R devel
library(EpiDISH)

# data wrangling and plotting
library(dplyr)
library(ggplot2)
library(tidyr)

library(planet)

# load example data
data("plBetas")
data("plCellCpGsThird")
head(plCellCpGsThird)
```

After our reference cpg data is loaded, we can estimate cell composition by
applying either the Constrained Projection approach implemented by the R 
packages minfi or EpiDISH, or a non-constrained approach by EpiDish.

#### Minfi

```{r, message = FALSE, warning = FALSE, eval = FALSE}
houseman_estimates <- minfi:::projectCellType(
    plBetas[rownames(plCellCpGsThird), ],
    plCellCpGsThird,
    lessThanOne = FALSE
)

head(houseman_estimates)
```

#### EpiDish

```{r, message = FALSE}
# robust partial correlations
epidish_RPC <- epidish(
    beta.m = plBetas[rownames(plCellCpGsThird), ],
    ref.m = plCellCpGsThird,
    method = "RPC"
)

# CIBERSORT
epidish_CBS <- epidish(
    beta.m = plBetas[rownames(plCellCpGsThird), ],
    ref.m = plCellCpGsThird,
    method = "CBS"
)

# constrained projection (houseman 2012)
epidish_CP <- epidish(
    beta.m = plBetas[rownames(plCellCpGsThird), ],
    ref.m = plCellCpGsThird,
    method = "CP"
)
```

### Compare

We can compare the different cell composition estimates.

```{r cell-comp}
data("plColors")

# bind estimate data frames and reshape for plotting
bind_rows(
    #houseman_estimates %>% as.data.frame() %>% 
    #    mutate(algorithm = "CP (Houseman)"),
    epidish_RPC$estF %>% as.data.frame() %>% mutate(algorithm = "RPC"),
    epidish_CBS$estF %>% as.data.frame() %>% mutate(algorithm = "CBS"),
    epidish_CP$estF %>% as.data.frame() %>% mutate(algorithm = "CP (EpiDISH)")
) %>%
    mutate(sample = rep(rownames(houseman_estimates), 4)) %>%
    as_tibble() %>%
    pivot_longer(
        cols = -c(algorithm, sample),
        names_to = "component",
        values_to = "estimate"
    ) %>%

    # relevel for plot
    mutate(component = factor(component,
        levels = c(
            "nRBC", "Endothelial", "Hofbauer",
            "Stromal", "Trophoblasts",
            "Syncytiotrophoblast"
        )
    )) %>%

    # plot
    ggplot(aes(x = sample, y = estimate, fill = component)) +
    geom_bar(stat = "identity") +
    facet_wrap(~algorithm, ncol = 1) +
    scale_fill_manual(values = plColors) +
    scale_y_continuous(
        limits = c(-0.1, 1.1), breaks = c(0, 0.5, 1),
        labels = scales::percent
    ) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
    coord_cartesian(ylim = c(0, 1)) +
    labs(x = "", fill = "")
```

Some notes:

* Normalize your data with `minfi::preprocessNoob`
* Use all cell CpGs, if some are missing, estimates may vary
* If your samples have been processed in a particular manner, (e.g. sampling 
from maternal side) expect cell composition to reflect that

### References

1. [Victor Yuan, Desmond Hui, Yifan Yin et al. Cell-specific Characterization 
of the Placental Methylome, 29 October 2020, PREPRINT (Version 3) available at
Research Square](https://www.researchsquare.com/article/rs-38223/v3)

### Session Info

```{r}
sessionInfo()
```